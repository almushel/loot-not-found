<html>

<head>
	<style>
		* {
			background-color: #202020;
			margin: 0;
			padding: 0;
		}
	</style>
	<script src='globals.js'></script>
	<script src='physics.js'></script>
	<script src='graphics.js'></script>
	<script src='particles.js'></script>
	<script src='objects.js'></script>
	<script src='collision.js'></script>
	<script src='level.js'></script>
	<script src='camera.js'></script>
	<script src='ui.js'></script>
	<script src='input.js'></script>
	<script src='player.js'></script>
	<script>
		this.onload = () => {
			canvas = document.getElementById('canvas');
			ctx = canvas.getContext('2d');
			particles = new ParticleSystem(9 * 16 * 16);

			window.addEventListener('resize', resizeCanvas);
			window.addEventListener('orientationchange', resizeCanvas);
			resizeCanvas()
			setInterval(update, 1000 / 60);
		}

		function newGame() {
			particles.reset();
			currentLevel = generateLevel(9, 9);
			player.position.x = currentLevel.start.x;
			player.position.y = currentLevel.start.y;

			const DEBUG = true;
			if (DEBUG) {
				let centerTile = tileAtCoords(currentLevel.width / 2 * TILE_SIZE, currentLevel.height / 2 * TILE_SIZE);
				currentLevel.spawnTile(centerTile + 11, WATER);
				currentLevel.spawnTile(centerTile - 11, OIL);

				currentLevel.objects.push(new Key(player.x - TILE_SIZE * 4, player.y));
				currentLevel.objects.push(new FireBomb(player.x + TILE_SIZE * 4, player.y));

			}
			gameState = 1
		}

		function update() {
			switch (gameState) {
				case 0: {
					if (controls.interact) {
						newGame();
					}
					drawMainMenu();
				} break;
				case 1: {
					physicsUpdate();
					updateCamera();
					draw();
				} break;
				case 2:  {
				
				} break;
				case 3:  {
				
				} break;
			}
		}

		function draw() {
			ctx.clearRect(0, 0, w, h);
			ctx.translate(-panX, -panY);
			currentLevel.draw();
			particles.draw();
			for (object of currentLevel.objects) {
				object.draw(object.position.x, object.position.y);
			}
			player.draw();
			ctx.translate(panX, panY);
			drawUI();
		}

		function shuffle(array) {
			let currentIndex = array.length, randomIndex, currentElement;

			while (currentIndex) {
				randomIndex = Math.floor(Math.random() * currentIndex--);

				currentElement = array[currentIndex];
				array[currentIndex] = array[randomIndex];
				array[randomIndex] = currentElement;
			}

			return array;
		}

		function clamp(value, min, max) {
			return Math.min(max, Math.max(value, min));
		}

		function lerp(start, end, weight) {
			return (1 - clamp(weight, 0, 1)) * start + clamp(weight, 0, 1) * end;
		}

		function smoothStart(weight, magnitude) {
			let sWeight = weight;
			for (let i = 0; i < magnitude; i++) {
				sWeight *= weight;
			}

			return sWeight;
		}

		function smoothStop(weight, magnitude) {
			let sWeight = 1 - weight;
			for (let i = 0; i < magnitude; i++) {
				sWeight *= (1 - weight);
			}

			return 1 - sWeight;
		}

	</script>
</head>

<body>
	<canvas id="canvas"></canvas>
</body>

</html>